<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.js"></script>

    <!-- plugins -->


    <!-- test data -->
    <script src="data.js"></script>

    <script src="countries.js"></script>
    <script src="tpStories.js"></script>
    <script src="dataTp.js"></script>

    <!-- css -->
    <link href="../css/layout.css" rel="stylesheet"/>
    <link href="../css/base.css" rel="stylesheet"/>
    <link href="../css/legend.css" rel="stylesheet"/>
    <link href="../css/tauCharts.css" rel="stylesheet"/>
    <link href="../css/tooltip.css" rel="stylesheet"/>
    <link href="../css/trendline.css" rel="stylesheet"/>
    <style>
        .cc {
            /*background-color: rgba(125, 125, 125, 0.5);*/
        }
    </style>
</head>
<body>

<div id="container" class="cc"></div>

</div>

<script src="../build/development/tauCharts.js"></script>
<script>

    var spec = {

        sources: {
            '/': {
                dims: {
                    project : {type: 'category'},
                    team    : {type: 'category'},
                    count   : {type: 'measure'},
                    date    : {type: 'measure'}
                },
                data: [
                    {project: 'TP3', team: 'alpha', count: 10, date: new Date('2014-01-05')},
                    {project: 'tau', team: 'xbeta', count: 15, date: new Date('2014-10-05')}
                ]
            }
        },

        scales: {
            'proj': {type: 'ordinal', name: 'A', fitToFrame: true, source: '/', dim: 'project'},
            'team': {type: 'ordinal', name: 'B', fitToFrame: true, source: '/', dim: 'team'} //,
//            'per_date': {type: 'period', name: 'C', fitToFrame: true, source: '/', dim: 'date', period: 'month'},
//            'date': {type: 'time', name: 'D', fitToFrame: true, source: '/', dim: 'date'},
//            'count': {
//                type: 'measure',
//                name: 'E',
//                fitToFrame: true,
//                source: '/',
//                dim: 'count',
//                min: 0,
//                max: 1000,
//                autoScale: true
//            },
//            'color_team': {type: 'color', name: 'F', fitToFrame: true, source: '/', dim: 'team', brewer: 'default'},
//            'size_count': {
//                type: 'size',
//                name: 'G',
//                fitToFrame: true,
//                source: '/',
//                dim: 'count',
//                min: 1,
//                max: 1000,
//                mid: 20
//            }
        },

        unit: {
            type: 'COORDS.RECT',
            x: 'proj',
            y: 'team',
            frames: [
                {
                    data: '/',
                    pipe: [{where: {project: 'tp2', team: 'alpha'}}],
                    unit: [
                        {
                            type: 'ELEMENT.POINT',
                            color: 'color_type',
                            size: 'size_count',
                            expr: '=cross(color_type, range(size_count))',
                            frames: [
                                {
                                    key: {type: 'bug'},
                                    data: '/',
                                    pipe: [
                                        {where: {project: 'tp2', team: 'alpha'}},
                                        {where: {type: 'bug'}}
                                    ]
                                },
                                {
                                    key: {type: 'story'},
                                    data: '/',
                                    pipe: [
                                        {where: {project: 'tp2', team: 'alpha'}},
                                        {where: {type: 'story'}}
                                    ]
                                }
                            ]
                        }
                    ]
                },

                {
                    key: {project: 'tp2', team: 'alpha'},
                    data: '/',
                    pipe: [{where: {project: 'tp2', team: 'alpha'}}],
                    unit: [
                        {
                            type: 'COORDS.RECT',
                            x: 'date',
                            y: 'count',
                            frames: [
                                {
                                    data: '/',
                                    pipe: [{where: {project: 'tp2', team: 'alpha'}}],
                                    unit: [
                                        {
                                            type: 'ELEMENT.INTERVAL',
                                            color: 'color_type',
                                            size: 'size_count',
                                            expr: '=cross(color_type, range(size_count))',
                                            frames: [
                                                {
                                                    key: {type: 'bug'},
                                                    data: '/',
                                                    pipe: [
                                                        {where: {project: 'tp2', team: 'alpha'}},
                                                        {where: {type: 'bug'}}
                                                    ]
                                                },
                                                {
                                                    key: {type: 'story'},
                                                    data: '/',
                                                    pipe: [
                                                        {where: {project: 'tp2', team: 'alpha'}},
                                                        {where: {type: 'story'}}
                                                    ]
                                                }
                                            ]
                                        },
                                        {
                                            type: 'ELEMENT.LINE',
                                            color: 'color_type',
                                            size: 'size_count',
                                            expr: '=[color_type]*1',
                                            frames: [
                                                {
                                                    key: {type: 'bug'},
                                                    data: '/',
                                                    pipe: [
                                                        {where: {project: 'tp2', team: 'alpha'}},
                                                        {where: {type: 'bug'}},
                                                        'linear_regression'
                                                    ]
                                                },
                                                {
                                                    key: {type: 'story'},
                                                    data: '/',
                                                    pipe: [
                                                        {where: {project: 'tp2', team: 'alpha'}},
                                                        {where: {type: 'story'}},
                                                        'linear_regression'
                                                    ]
                                                }
                                            ]
                                        },
                                        {
                                            type: 'ELEMENT.LINE',
                                            expr: '=1',
                                            frames: [
                                                {
                                                    data: '/',
                                                    pipe: [
                                                        {where: {project: 'tp2', team: 'alpha'}},
                                                        'linear_regression'
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ],
                            unit: [
                                {
                                    type: 'ELEMENT.POINT',
                                    color: 'color_team'
                                },
                                {
                                    type: 'ELEMENT.LINE',
                                    color: 'color_team',
                                    trans: ['linear_regression']
                                },
                                {
                                    type: 'ELEMENT.LINE',
                                    trans: ['linear_regression']
                                }
                            ]
                        }
                    ]
                }
            ],
            unit: [
                {
                    type: 'COORDS.RECT',
                    x: 'date',
                    y: 'count',
                    func: '1',
                    unit: [
                        {
                            type: 'ELEMENT.POINT',
                            color: 'color_team'
                        },
                        {
                            type: 'ELEMENT.LINE',
                            color: 'color_team',
                            trans: ['linear_regression']
                        },
                        {
                            type: 'ELEMENT.LINE',
                            trans: ['linear_regression']
                        }
                    ]
                }
            ]
        }
    };

    var xSpec = {

        sources: {
            '?': {
                dims: {},
                data: []
            },
            '/': {
                dims: {
                    story   : {type: 'category'},
                    bug     : {type: 'category'},
                    project : {type: 'category'},
                    team    : {type: 'category'},
                    count   : {type: 'measure'},
                    date    : {type: 'measure'}
                },
                data: [
                    {project: 'TP3', team: 'alpha', story: 'A1', bug: 'ISSUE1', count: 10, date: new Date('2014-01-05')},
                    {project: 'tau', team: 'xbeta', story: 'B1', bug: 'ISSUE2', count: 15, date: new Date('2014-10-05')}
                ]
            }
        },

        trans: {
            where: function (data, tuple) {
                var predicates = _.map(tuple, function(v, k) {
                    return function(row) {
                        return (row[k] === v);
                    }
                });
                return _(data).filter(function(row) {
                    return _.every(predicates, function(p) {
                        return p(row);
                    })
                });
            }
        },

        scales: {
            'size:default'  : {type: 'size',  name: 'DefSize',  fitToFrame: false, source: '?', mid: 5},
            'color:default' : {type: 'color', name: 'DefColor', fitToFrame: false, source: '?', brewer: null},
            'story' : {type: 'ordinal', name: 'S', fitToFrame: false, source: '/', dim: 'story'},
            'bug'   : {type: 'ordinal', name: 'B', fitToFrame: false, source: '/', dim: 'bug'},
            'proj'  : {type: 'ordinal', name: 'P', fitToFrame: false, source: '/', dim: 'project'},
            'team'  : {type: 'ordinal', name: 'T', fitToFrame: false, source: '/', dim: 'team'}
        },

        unit: {
            type: 'RECT',
            x: 'proj',
            y: 'team',
            expr: ['cross', '/', false, 'project', 'team'],
            guide: {
                padding: {l: 40, r: 0, t: 0, b: 40},
                showGridLines: 'xy',
                x: {
                    textAnchor: 'middle',
                    padding: 10,
                    hide: false,
                    scaleOrient: 'bottom',
                    rotate: 0,
                    density: 20,
                    label: {text: 'proj', rotate: 0, padding: 20, textAnchor: 'middle'},
                    tickFormatWordWrapLimit: 100
                },
                y: {
                    //textAnchor: 'middle',
                    padding: 10,
                    hide: false,
                    scaleOrient: 'left',
                    rotate: -90,
                    density: 0,
                    label: {text: 'team', rotate: -90, padding: 20, textAnchor: 'middle'},
                    tickFormatWordWrapLimit: 100
                }
            },
            unit: [
                {
                    type: 'RECT',
                    x: 'bug',
                    y: 'story',
                    expr: ['none', '/', true],
                    guide: {
                        padding: {l: 40, r: 0, t: 0, b: 40},
                        showGridLines: 'xy',
                        x: {
                            textAnchor: 'middle',
                            padding: 10,
                            hide: false,
                            scaleOrient: 'bottom',
                            rotate: 0,
                            density: 20,
                            label: {text: 'bug', rotate: 0, padding: 20, textAnchor: 'middle'},
                            tickFormatWordWrapLimit: 100
                        },
                        y: {
                            //textAnchor: 'middle',
                            padding: 10,
                            hide: false,
                            scaleOrient: 'left',
                            rotate: -90,
                            density: 0,
                            label: {text: 'story', rotate: -90, padding: 20, textAnchor: 'middle'},
                            tickFormatWordWrapLimit: 100
                        }
                    },
                    unit: [
                        {
                            type: 'POINT',
                            x: 'bug',
                            y: 'story',
                            expr: ['none', '/', true],
                            guide: {
                                padding: {l: 0, r: 0, t: 0, b: 0},
                                x: {padding: 0, hide: false},
                                y: {padding: 0, hide: false}
                            }
                        }
                    ]
                }
            ]
        }
    };

    var gpl = new tauCharts.GPL(xSpec);

    gpl.render('#container', {width: 800, height: 600});
</script>
</body>
</html>
